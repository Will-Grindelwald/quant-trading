# QuantCapital æ··åˆé‡åŒ–äº¤æ˜“ç³»ç»Ÿ - å¼€å‘è€…æŒ‡å—

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ··åˆæ¶æ„è®¾è®¡åŸåˆ™

æœ¬é¡¹ç›®é‡‡ç”¨Python+Javaæ··åˆæ¶æ„ï¼ŒåŸºäºä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå„æ¨¡å—èŒè´£æ¸…æ™°ï¼Œä½è€¦åˆé«˜å†…èš
2. **äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡äº‹ä»¶æ€»çº¿å®ç°æ¨¡å—é—´é€šä¿¡ï¼Œå¼‚æ­¥å¤„ç†
3. **è¿›ç¨‹åˆ†ç¦»**ï¼šæ•°æ®è·å–è¿›ç¨‹ä¸äº¤æ˜“å¼•æ“è¿›ç¨‹ç‹¬ç«‹è¿è¡Œ
4. **ä¸€è‡´æ€§ä¿è¯**ï¼šå›æµ‹ä¸å®ç›˜å…±äº«æ ¸å¿ƒä»£ç ï¼Œç¡®ä¿ç­–ç•¥ä¸€è‡´æ€§
5. **é«˜æ€§èƒ½ä¼˜åŒ–**ï¼šJavaç«¯é‡‡ç”¨è™šæ‹Ÿçº¿ç¨‹ã€åˆ—å¼å­˜å‚¨ç­‰æŠ€æœ¯
6. **å¯æ’æ‹”ç»„ä»¶**ï¼šç­–ç•¥ã€æ•°æ®æºã€æ‰§è¡Œå™¨æ”¯æŒæ’ä»¶æœºåˆ¶

### ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "Python æ•°æ®å¤„ç†å±‚"
        A[AKShareæ•°æ®è·å–] --> B[æŠ€æœ¯æŒ‡æ ‡è®¡ç®—]
        B --> C[æ•°æ®æ¸…æ´—éªŒè¯]
        C --> D[å­˜å‚¨ç®¡ç†å™¨]
        D --> E[Parquetæ–‡ä»¶<br/>Kçº¿æ•°æ®]
        D --> F[DuckDB<br/>æ—¶åºæ•°æ®]
        D --> G[SQLite<br/>ä¸šåŠ¡æ•°æ®]
    end
    
    subgraph "Java äº¤æ˜“å¼•æ“å±‚"
        H[äº‹ä»¶é©±åŠ¨å¼•æ“<br/>EventEngine] --> I[ç­–ç•¥æ‰§è¡Œæ¡†æ¶<br/>StrategyManager]
        I --> J[ç»„åˆé£æ§ç³»ç»Ÿ<br/>PortfolioManager]
        J --> K[äº¤æ˜“æ‰§è¡Œå¼•æ“<br/>ExecutionHandler]
        K --> L[å›æµ‹/å®ç›˜å¼•æ“<br/>BacktestEngine]
    end
    
    subgraph "æ•°æ®æ¥å£å±‚"
        M[DataHandler<br/>ç»Ÿä¸€æ•°æ®æ¥å£]
        N[Parquet Reader]
        O[DuckDB JDBC]
        P[SQLite JDBC]
    end
    
    E --> N
    F --> O  
    G --> P
    N --> M
    O --> M
    P --> M
    M --> H
    
    subgraph "ç­–ç•¥å±‚"
        Q[å¼€å•ç­–ç•¥<br/>Entry Strategy]
        R[å¹³ä»“ç­–ç•¥<br/>Exit Strategy] 
        S[æ­¢æŸç­–ç•¥<br/>Stop Strategy]
    end
    
    I --> Q
    I --> R
    I --> S
```

### æŠ€æœ¯æ ˆ

#### Pythonç«¯æŠ€æœ¯æ ˆ
- **æ•°æ®è·å–**: AKShare, tushare
- **æ•°æ®å¤„ç†**: pandas, numpy, talib
- **å­˜å‚¨**: Parquet, DuckDB, SQLite
- **å¹¶å‘**: asyncio, threading
- **é…ç½®**: pydantic, yaml

#### Javaç«¯æŠ€æœ¯æ ˆ
- **æ ¸å¿ƒæ¡†æ¶**: Spring Boot 3, JDK 21, Maven
- **æ•°æ®å¤„ç†**: Tablesaw, Apache Arrow, Apache Parquet
- **æ•°æ®åº“**: DuckDB JDBC, SQLite JDBC
- **å¹¶å‘**: è™šæ‹Ÿçº¿ç¨‹, BlockingQueue, ExecutorService
- **åºåˆ—åŒ–**: Jackson
- **å·¥å…·åº“**: Lombok, Guava, Commons Lang
- **æµ‹è¯•**: JUnit 5, Mockito, AssertJ
- **ç›‘æ§**: Spring Actuator

#### æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
- **ZGCåƒåœ¾æ”¶é›†å™¨**: ä½å»¶è¿ŸGCï¼Œåœé¡¿æ—¶é—´<10ms
- **è™šæ‹Ÿçº¿ç¨‹**: Project Loomï¼Œè½»é‡çº§å¹¶å‘
- **Apache Arrow**: å†…å­˜åˆ—å¼å­˜å‚¨ï¼Œé«˜æ•ˆæ•°æ®äº¤æ¢
- **DuckDB**: å†…å­˜åˆ†ææ•°æ®åº“ï¼Œåˆ—å¼æŸ¥è¯¢ä¼˜åŒ–

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
quant-trading/
â”œâ”€â”€ python/                          # Pythonæ•°æ®å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ quantcapital/               # æ ¸å¿ƒPythonåº“
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ backtest/               # å›æµ‹å¼•æ“
â”‚   â”‚   â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ data/                   # æ•°æ®å¤„ç†
â”‚   â”‚   â”œâ”€â”€ engine/                 # äº‹ä»¶å¼•æ“
â”‚   â”‚   â”œâ”€â”€ entities/               # å®ä½“å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ execution/              # æ‰§è¡Œå¼•æ“
â”‚   â”‚   â”œâ”€â”€ portfolio/              # ç»„åˆç®¡ç†
â”‚   â”‚   â””â”€â”€ strategy/               # ç­–ç•¥åŸºç±»
â”‚   â””â”€â”€ examples/                   # Pythonç¤ºä¾‹
â”œâ”€â”€ src/                            # Javaäº¤æ˜“å¼•æ“
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/com/quantcapital/
â”‚   â”‚   â”‚   â”œâ”€â”€ QuantCapitalApplication.java  # ä¸»åº”ç”¨
â”‚   â”‚   â”‚   â”œâ”€â”€ config/             # é…ç½®ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/           # å®ä½“æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ engine/             # äº‹ä»¶å¼•æ“
â”‚   â”‚   â”‚   â”œâ”€â”€ interfaces/         # æ ¸å¿ƒæ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ strategy/           # ç­–ç•¥æ¡†æ¶
â”‚   â”‚   â”‚   â””â”€â”€ utils/              # å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.yml     # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”‚       â””â”€â”€ logback-spring.xml  # æ—¥å¿—é…ç½®
â”‚   â””â”€â”€ test/                       # æµ‹è¯•ä»£ç 
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ python/                     # Pythonç¤ºä¾‹
â”‚   â””â”€â”€ java/                       # Javaç¤ºä¾‹
â”œâ”€â”€ docs/                           # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ ç”¨æˆ·æ‰‹å†Œ.md                 # ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ
â”‚   â””â”€â”€ å¼€å‘è€…æŒ‡å—.md               # æœ¬æ–‡ä»¶
â”œâ”€â”€ requirements.txt                # Pythonä¾èµ–
â”œâ”€â”€ pom.xml                        # Mavené…ç½®
â”œâ”€â”€ java_migration_guide.md        # è¿ç§»æŒ‡å—
â””â”€â”€ README.md                      # é¡¹ç›®è¯´æ˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. äº‹ä»¶é©±åŠ¨å¼•æ“ (EventEngine)

```java
@Component
public class EventEngine {
    
    // ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ”¯æŒäº‹ä»¶ä¼˜å…ˆçº§å¤„ç†
    private final BlockingQueue<Event> eventQueue = new PriorityBlockingQueue<>();
    
    // è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œå™¨ï¼Œé«˜å¹¶å‘ä½å»¶è¿Ÿ
    private final ExecutorService eventProcessor = Executors.newVirtualThreadPerTaskExecutor();
    
    // äº‹ä»¶å¤„ç†å™¨æ³¨å†Œè¡¨
    private final Map<Class<? extends Event>, List<EventHandler>> handlers = new ConcurrentHashMap<>();
    
    /**
     * å‘å¸ƒäº‹ä»¶åˆ°é˜Ÿåˆ—
     */
    public void publish(Event event) {
        event.setTimestamp(System.nanoTime());  // çº³ç§’çº§æ—¶é—´æˆ³
        boolean success = eventQueue.offer(event);
        if (!success) {
            // é˜Ÿåˆ—æ»¡æ—¶çš„èƒŒå‹å¤„ç†
            handleBackpressure(event);
        }
        eventMetrics.incrementPublished();
    }
    
    /**
     * å¼‚æ­¥å¤„ç†äº‹ä»¶
     */
    private void processEvents() {
        while (running.get()) {
            try {
                Event event = eventQueue.take();  // é˜»å¡è·å–
                eventProcessor.submit(() -> handleEvent(event));
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
    }
    
    /**
     * åˆ†å‘äº‹ä»¶åˆ°å¯¹åº”å¤„ç†å™¨
     */
    private void handleEvent(Event event) {
        List<EventHandler> eventHandlers = handlers.get(event.getClass());
        if (eventHandlers != null) {
            for (EventHandler handler : eventHandlers) {
                try {
                    handler.handle(event);
                } catch (Exception e) {
                    logger.error("äº‹ä»¶å¤„ç†å¤±è´¥", e);
                    eventMetrics.incrementFailed();
                }
            }
        }
        eventMetrics.incrementProcessed();
    }
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- åŸºäºä¼˜å…ˆçº§é˜Ÿåˆ—çš„äº‹ä»¶è°ƒåº¦
- è™šæ‹Ÿçº¿ç¨‹å®ç°é«˜å¹¶å‘å¤„ç†
- æ•…éšœéš”ç¦»ï¼Œå•ä¸ªå¤„ç†å™¨å¼‚å¸¸ä¸å½±å“å…¶ä»–
- èƒŒå‹å¤„ç†æœºåˆ¶ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- è¯¦ç»†çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### 2. æ•°æ®å¤„ç†æ¥å£ (DataHandler)

```java
public interface DataHandler {
    
    /**
     * ä»Python Parquetæ–‡ä»¶è¯»å–Kçº¿æ•°æ®
     */
    List<Bar> readParquetData(String symbol, LocalDate startDate, LocalDate endDate);
    
    /**
     * ä»DuckDBè¯»å–æŠ€æœ¯æŒ‡æ ‡æ•°æ®
     */
    Map<String, Double> readIndicators(String symbol, LocalDate date);
    
    /**
     * ä»SQLiteè¯»å–ä¸šåŠ¡æ•°æ®
     */
    UniverseInfo readUniverseData(String symbol);
    
    /**
     * è®¢é˜…å®æ—¶å¸‚åœºæ•°æ®
     */
    void subscribeMarketData(String symbol, MarketDataListener listener);
    
    /**
     * è·å–å†å²å¤æƒå› å­
     */
    AdjustFactor getAdjustFactor(String symbol, LocalDate date);
}

@Service
public class ParquetDataHandler implements DataHandler {
    
    @Value("${quantcapital.data.parquet-path}")
    private String parquetPath;
    
    // ä½¿ç”¨Apache Arrowçš„å†…å­˜æ˜ å°„è¯»å–
    @Override
    public List<Bar> readParquetData(String symbol, LocalDate startDate, LocalDate endDate) {
        String filePath = String.format("%s/%s.parquet", parquetPath, symbol);
        
        try (ParquetFileReader reader = ParquetFileReader.open(HadoopInputFile.fromPath(
                new Path(filePath), new Configuration()))) {
            
            // åˆ—å¼è¯»å–ï¼Œåªè¯»å–éœ€è¦çš„åˆ—
            MessageType schema = reader.getFooter().getFileMetaData().getSchema();
            ParquetReadOptions options = ParquetReadOptions.builder()
                .withRange(startDate, endDate)  // æ—¶é—´èŒƒå›´è¿‡æ»¤
                .build();
                
            return convertToBarList(reader, options);
        } catch (IOException e) {
            throw new DataAccessException("è¯»å–Parquetæ–‡ä»¶å¤±è´¥: " + symbol, e);
        }
    }
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ï¼Œéš”ç¦»åº•å±‚å­˜å‚¨å·®å¼‚
- åˆ—å¼å­˜å‚¨è¯»å–ä¼˜åŒ–ï¼ŒæŒ‰éœ€åŠ è½½æ•°æ®
- å†…å­˜æ˜ å°„æŠ€æœ¯ï¼Œæé«˜å¤§æ–‡ä»¶è¯»å–æ€§èƒ½
- æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼Œå‡å°‘æ— æ•ˆæ•°æ®åŠ è½½

### 3. ç­–ç•¥æ¡†æ¶ (BaseStrategy)

```java
public abstract class BaseStrategy {
    
    protected String strategyId;
    protected String name;
    protected StrategyType type;
    protected Map<String, Object> parameters;
    
    /**
     * å¸‚åœºæ•°æ®äº‹ä»¶å¤„ç† - æ ¸å¿ƒç­–ç•¥é€»è¾‘
     */
    public abstract void onBar(Bar bar);
    
    /**
     * å®šæ—¶å™¨äº‹ä»¶å¤„ç† - å®šæœŸæ£€æŸ¥å’Œæ¸…ç†
     */
    public void onTimer(TimerEvent event) {
        // é»˜è®¤å®ç°ä¸ºç©ºï¼Œå­ç±»å¯é€‰æ‹©é‡å†™
    }
    
    /**
     * è®¢å•æˆäº¤äº‹ä»¶å¤„ç† - ä»“ä½ç®¡ç†
     */
    public void onFill(FillEvent fill) {
        // æ›´æ–°ç­–ç•¥å†…éƒ¨çŠ¶æ€
        updateInternalState(fill);
    }
    
    /**
     * å‘é€äº¤æ˜“ä¿¡å·
     */
    protected void sendSignal(String symbol, SignalType type, double strength, String reason) {
        SignalEvent signal = SignalEvent.builder()
            .strategyId(this.strategyId)
            .symbol(symbol)
            .signalType(type)
            .strength(strength)
            .reason(reason)
            .timestamp(System.currentTimeMillis())
            .build();
            
        eventEngine.publish(signal);
    }
    
    /**
     * è·å–æŠ€æœ¯æŒ‡æ ‡æ•°æ®
     */
    protected double getIndicator(String symbol, String indicator, int period) {
        return indicatorService.getValue(symbol, indicator, period);
    }
    
    /**
     * è·å–å½“å‰æŒä»“
     */
    protected Position getPosition(String symbol) {
        return portfolioManager.getPosition(symbol);
    }
}

// å…·ä½“ç­–ç•¥å®ç°ç¤ºä¾‹
@Component
public class MeanReversionStrategy extends BaseStrategy {
    
    @Value("${strategy.mean-reversion.lookback:20}")
    private int lookbackPeriod;
    
    @Value("${strategy.mean-reversion.threshold:2.0}")
    private double threshold;
    
    @Override
    public void onBar(Bar bar) {
        String symbol = bar.getSymbol();
        double currentPrice = bar.getClose();
        
        // è®¡ç®—å¸ƒæ—å¸¦
        double sma = getIndicator(symbol, "SMA", lookbackPeriod);
        double std = getIndicator(symbol, "STD", lookbackPeriod);
        double upperBand = sma + threshold * std;
        double lowerBand = sma - threshold * std;
        
        Position position = getPosition(symbol);
        
        // å‡å€¼å›å½’ç­–ç•¥é€»è¾‘
        if (currentPrice < lowerBand && position.getQuantity() <= 0) {
            // ä»·æ ¼è·Œç ´ä¸‹è½¨ï¼Œä¹°å…¥
            sendSignal(symbol, SignalType.LONG, 0.8, 
                "ä»·æ ¼è·Œç ´å¸ƒæ—å¸¦ä¸‹è½¨ï¼Œå‡å€¼å›å½’ä¹°å…¥ä¿¡å·");
        } else if (currentPrice > upperBand && position.getQuantity() >= 0) {
            // ä»·æ ¼çªç ´ä¸Šè½¨ï¼Œå–å‡º
            sendSignal(symbol, SignalType.SHORT, 0.8, 
                "ä»·æ ¼çªç ´å¸ƒæ—å¸¦ä¸Šè½¨ï¼Œå‡å€¼å›å½’å–å‡ºä¿¡å·");
        }
    }
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå®šä¹‰ç­–ç•¥å¼€å‘æ¡†æ¶
- äº‹ä»¶é©±åŠ¨æ¥å£ï¼Œæ”¯æŒå¤šç§äº‹ä»¶ç±»å‹
- å†…ç½®å·¥å…·æ–¹æ³•ï¼Œç®€åŒ–ç­–ç•¥å¼€å‘
- å‚æ•°åŒ–é…ç½®ï¼Œæ”¯æŒç­–ç•¥è°ƒä¼˜

### 4. é£é™©ç®¡ç†ç³»ç»Ÿ

```java
@Component
public class RiskManager {
    
    @Value("${quantcapital.risk.max-position-pct:0.05}")
    private double maxPositionPct;
    
    @Value("${quantcapital.risk.max-total-position-pct:0.95}")
    private double maxTotalPositionPct;
    
    @Value("${quantcapital.risk.daily-loss-limit:0.02}")
    private double dailyLossLimit;
    
    /**
     * è®¢å•å‰é£æ§æ£€æŸ¥
     */
    public RiskCheckResult checkOrderRisk(OrderEvent order) {
        List<String> violations = new ArrayList<>();
        
        // 1. ä»“ä½é£æ§æ£€æŸ¥
        if (!checkPositionLimit(order)) {
            violations.add("è¶…è¿‡å•æ ‡çš„æœ€å¤§ä»“ä½é™åˆ¶");
        }
        
        // 2. æ€»ä»“ä½æ£€æŸ¥
        if (!checkTotalPositionLimit(order)) {
            violations.add("è¶…è¿‡æ€»ä»“ä½é™åˆ¶");
        }
        
        // 3. èµ„é‡‘å……è¶³æ€§æ£€æŸ¥
        if (!checkCapitalSufficiency(order)) {
            violations.add("å¯ç”¨èµ„é‡‘ä¸è¶³");
        }
        
        // 4. æ—¥å†…äºæŸæ£€æŸ¥
        if (!checkDailyLossLimit()) {
            violations.add("è§¦åŠæ—¥å†…äºæŸé™é¢");
        }
        
        // 5. æ ‡çš„åˆè§„æ€§æ£€æŸ¥
        if (!checkSymbolCompliance(order.getSymbol())) {
            violations.add("æ ‡çš„ä¸ç¬¦åˆäº¤æ˜“è§„åˆ™");
        }
        
        return new RiskCheckResult(violations.isEmpty(), violations);
    }
    
    private boolean checkPositionLimit(OrderEvent order) {
        String symbol = order.getSymbol();
        Position position = portfolioManager.getPosition(symbol);
        double portfolioValue = portfolioManager.getTotalValue();
        
        double newPositionValue = position.getMarketValue() + order.getValue();
        double positionPct = newPositionValue / portfolioValue;
        
        return positionPct <= maxPositionPct;
    }
    
    private boolean checkTotalPositionLimit(OrderEvent order) {
        double totalPositionValue = portfolioManager.getTotalPositionValue();
        double portfolioValue = portfolioManager.getTotalValue();
        
        double newTotalPositionValue = totalPositionValue + order.getValue();
        double totalPositionPct = newTotalPositionValue / portfolioValue;
        
        return totalPositionPct <= maxTotalPositionPct;
    }
}
```

## ğŸ“Š æ•°æ®æµå¤„ç†

### Pythonæ•°æ®ç”Ÿæˆæµç¨‹

```python
# æ•°æ®è·å–å’Œå¤„ç†ç®¡é“
class DataPipeline:
    
    def __init__(self, config):
        self.config = config
        self.ak_client = ak  # AKShareå®¢æˆ·ç«¯
        self.duckdb_conn = duckdb.connect(config.duckdb_path)
        
    def fetch_and_process_data(self, symbols: List[str], start_date: str, end_date: str):
        """è·å–å¹¶å¤„ç†è‚¡ç¥¨æ•°æ®"""
        
        for symbol in symbols:
            try:
                # 1. è·å–åŸå§‹æ•°æ®
                raw_data = self.fetch_raw_data(symbol, start_date, end_date)
                
                # 2. æ•°æ®æ¸…æ´—å’ŒéªŒè¯
                clean_data = self.clean_data(raw_data)
                
                # 3. è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
                enriched_data = self.calculate_indicators(clean_data)
                
                # 4. å­˜å‚¨åˆ°å¤šä¸ªæ ¼å¼
                self.save_to_parquet(symbol, enriched_data)
                self.save_to_duckdb(symbol, enriched_data)
                self.save_metadata_to_sqlite(symbol, enriched_data)
                
                logger.info(f"å¤„ç†å®Œæˆ: {symbol}")
                
            except Exception as e:
                logger.error(f"å¤„ç†å¤±è´¥ {symbol}: {e}")
                
    def calculate_indicators(self, data: pd.DataFrame) -> pd.DataFrame:
        """è®¡ç®—æŠ€æœ¯æŒ‡æ ‡"""
        
        # ç§»åŠ¨å¹³å‡çº¿
        data['ma5'] = talib.SMA(data['close'], timeperiod=5)
        data['ma10'] = talib.SMA(data['close'], timeperiod=10)
        data['ma20'] = talib.SMA(data['close'], timeperiod=20)
        data['ma60'] = talib.SMA(data['close'], timeperiod=60)
        
        # å¸ƒæ—å¸¦
        data['bb_upper'], data['bb_middle'], data['bb_lower'] = talib.BBANDS(
            data['close'], timeperiod=20)
        
        # RSI
        data['rsi'] = talib.RSI(data['close'], timeperiod=14)
        
        # MACD
        data['macd'], data['macd_signal'], data['macd_hist'] = talib.MACD(data['close'])
        
        # KDJ
        data['k'], data['d'] = talib.STOCH(data['high'], data['low'], data['close'])
        data['j'] = 3 * data['k'] - 2 * data['d']
        
        return data
```

### Javaæ•°æ®æ¶ˆè´¹æµç¨‹

```java
@Component
public class MarketDataProcessor {
    
    @Autowired
    private DataHandler dataHandler;
    
    @Autowired
    private EventEngine eventEngine;
    
    /**
     * å›æµ‹æ¨¡å¼æ•°æ®å›æ”¾
     */
    public void replayHistoricalData(BacktestConfig config) {
        LocalDate currentDate = config.getStartDate();
        LocalDate endDate = config.getEndDate();
        
        while (!currentDate.isAfter(endDate)) {
            // è¯»å–å½“æ—¥æ‰€æœ‰æ ‡çš„æ•°æ®
            List<Bar> dailyBars = loadDailyBars(config.getUniverse(), currentDate);
            
            // æŒ‰æ—¶é—´æ’åºåä¾æ¬¡å‘é€MarketEvent
            dailyBars.stream()
                .sorted(Comparator.comparing(Bar::getTimestamp))
                .forEach(bar -> {
                    MarketEvent event = new MarketEvent(bar);
                    eventEngine.publish(event);
                });
                
            currentDate = currentDate.plusDays(1);
            
            // æ§åˆ¶å›æ”¾é€Ÿåº¦
            if (config.getReplaySpeed() > 0) {
                ThreadUtils.sleep(1000 / config.getReplaySpeed());
            }
        }
    }
    
    /**
     * å®ç›˜æ¨¡å¼æ•°æ®æ¥æ”¶
     */
    public void startLiveDataFeed() {
        // è®¢é˜…å®æ—¶æ•°æ®æº
        dataHandler.subscribeMarketData("*", this::onMarketData);
    }
    
    private void onMarketData(Bar bar) {
        // å‘é€å®æ—¶å¸‚åœºäº‹ä»¶
        MarketEvent event = new MarketEvent(bar);
        eventEngine.publish(event);
    }
}
```

## ğŸ§ª æµ‹è¯•æ¡†æ¶

### å•å…ƒæµ‹è¯•è§„èŒƒ

```java
@ExtendWith(MockitoExtension.class)
class EventEngineTest {
    
    @Mock
    private EventHandler mockHandler;
    
    @InjectMocks
    private EventEngine eventEngine;
    
    @BeforeEach
    void setUp() {
        eventEngine.registerHandler(TestEvent.class, mockHandler);
        eventEngine.start();
    }
    
    @Test
    @DisplayName("åº”è¯¥èƒ½å¤Ÿå‘å¸ƒå’Œå¤„ç†äº‹ä»¶")
    void shouldPublishAndHandleEvent() {
        // Given
        TestEvent event = new TestEvent("test-data");
        
        // When
        eventEngine.publish(event);
        
        // Then
        await().atMost(1, SECONDS)
            .untilAsserted(() -> verify(mockHandler).handle(event));
    }
    
    @Test
    @DisplayName("åº”è¯¥èƒ½å¤Ÿå¤„ç†å¤„ç†å™¨å¼‚å¸¸")
    void shouldHandleHandlerException() {
        // Given
        doThrow(RuntimeException.class).when(mockHandler).handle(any());
        
        // When & Then
        assertDoesNotThrow(() -> {
            eventEngine.publish(new TestEvent("test"));
            Thread.sleep(100);  // ç­‰å¾…å¼‚æ­¥å¤„ç†
        });
        
        // éªŒè¯äº‹ä»¶å¼•æ“ä»ç„¶è¿è¡Œ
        assertTrue(eventEngine.isRunning());
    }
}
```

### é›†æˆæµ‹è¯•

```java
@SpringBootTest
@TestPropertySource(properties = {
    "quantcapital.mode=backtest",
    "quantcapital.data.root-path=src/test/resources/test-data"
})
class BacktestIntegrationTest {
    
    @Autowired
    private BacktestEngine backtestEngine;
    
    @Test
    @DisplayName("å®Œæ•´å›æµ‹æµç¨‹æµ‹è¯•")
    void shouldRunCompleteBacktest() {
        // Given
        BacktestConfig config = BacktestConfig.builder()
            .startDate(LocalDate.of(2023, 1, 1))
            .endDate(LocalDate.of(2023, 1, 31))
            .initialCapital(1000000.0)
            .universe(List.of("000001.SZ", "000002.SZ"))
            .build();
        
        // When
        BacktestResult result = backtestEngine.runBacktest(config);
        
        // Then
        assertThat(result.getTotalReturn()).isGreaterThan(-0.5);  // æœ€å¤§äºæŸä¸è¶…è¿‡50%
        assertThat(result.getSharpeRatio()).isGreaterThan(0.0);   // å¤æ™®æ¯”ç‡ä¸ºæ­£
        assertThat(result.getMaxDrawdown()).isLessThan(0.2);      // æœ€å¤§å›æ’¤å°äº20%
    }
}
```

## ğŸ”§ å¼€å‘è§„èŒƒ

### ä»£ç è§„èŒƒ

1. **Javaå‘½åè§„èŒƒ**
   - ç±»åï¼šPascalCase (å¦‚ `EventEngine`)
   - æ–¹æ³•åï¼šcamelCase (å¦‚ `publishEvent`)
   - å¸¸é‡ï¼šUPPER_SNAKE_CASE (å¦‚ `MAX_QUEUE_SIZE`)
   - åŒ…åï¼šå°å†™+ç‚¹åˆ†å‰² (å¦‚ `com.quantcapital.engine`)

2. **Pythonå‘½åè§„èŒƒ**
   - ç±»åï¼šPascalCase (å¦‚ `DataManager`)
   - æ–¹æ³•åï¼šsnake_case (å¦‚ `fetch_data`)
   - å¸¸é‡ï¼šUPPER_SNAKE_CASE (å¦‚ `DEFAULT_TIMEOUT`)
   - æ¨¡å—åï¼šsnake_case (å¦‚ `data_handler`)

3. **æ³¨é‡Šè§„èŒƒ**
   ```java
   /**
    * å‘å¸ƒäº‹ä»¶åˆ°äº‹ä»¶é˜Ÿåˆ—
    * 
    * @param event è¦å‘å¸ƒçš„äº‹ä»¶å¯¹è±¡ï¼Œä¸èƒ½ä¸ºnull
    * @throws IllegalArgumentException å½“eventä¸ºnullæ—¶æŠ›å‡º
    * @throws QueueFullException å½“é˜Ÿåˆ—å·²æ»¡ä¸”æ— æ³•æ·»åŠ äº‹ä»¶æ—¶æŠ›å‡º
    */
   public void publish(@NonNull Event event) {
       // å®ç°ä»£ç ...
   }
   ```

### æ€§èƒ½ä¼˜åŒ–æŒ‡å—

1. **å†…å­˜ä¼˜åŒ–**
   ```java
   // ä½¿ç”¨å¯¹è±¡æ± é¿å…é¢‘ç¹åˆ›å»ºå¯¹è±¡
   private final ObjectPool<StringBuilder> stringBuilderPool = 
       new GenericObjectPool<>(new StringBuilderFactory());
   
   // ä½¿ç”¨åŸå§‹ç±»å‹é›†åˆé¿å…è£…ç®±
   private final TIntObjectHashMap<Position> positions = new TIntObjectHashMap<>();
   ```

2. **å¹¶å‘ä¼˜åŒ–**
   ```java
   // ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹å¤„ç†I/Oå¯†é›†å‹ä»»åŠ¡
   private final ExecutorService ioExecutor = 
       Executors.newVirtualThreadPerTaskExecutor();
   
   // ä½¿ç”¨æ— é”æ•°æ®ç»“æ„
   private final AtomicLong eventCounter = new AtomicLong(0);
   ```

3. **ç¼“å­˜ä¼˜åŒ–**
   ```java
   @Cacheable(value = "indicators", key = "#symbol + #date")
   public Map<String, Double> getIndicators(String symbol, LocalDate date) {
       return dataHandler.readIndicators(symbol, date);
   }
   ```

### ç›‘æ§å’Œè°ƒè¯•

1. **æ—¥å¿—é…ç½®**
   ```xml
   <!-- logback-spring.xml -->
   <configuration>
       <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
           <file>logs/quantcapital.log</file>
           <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
               <fileNamePattern>logs/quantcapital.%d{yyyy-MM-dd}.gz</fileNamePattern>
               <maxHistory>30</maxHistory>
           </rollingPolicy>
           <encoder>
               <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
           </encoder>
       </appender>
       
       <logger name="com.quantcapital" level="INFO"/>
       <logger name="com.quantcapital.engine" level="DEBUG"/>
       
       <root level="WARN">
           <appender-ref ref="FILE"/>
       </root>
   </configuration>
   ```

2. **æ€§èƒ½ç›‘æ§**
   ```java
   @Component
   public class PerformanceMonitor {
       
       private final MeterRegistry meterRegistry;
       private final Timer eventProcessingTimer;
       private final Counter eventCounter;
       
       public PerformanceMonitor(MeterRegistry meterRegistry) {
           this.meterRegistry = meterRegistry;
           this.eventProcessingTimer = Timer.builder("event.processing.time")
               .description("äº‹ä»¶å¤„ç†æ—¶é—´")
               .register(meterRegistry);
           this.eventCounter = Counter.builder("event.processed")
               .description("å·²å¤„ç†äº‹ä»¶æ•°")
               .register(meterRegistry);
       }
       
       public void recordEventProcessing(Duration duration) {
           eventProcessingTimer.record(duration);
           eventCounter.increment();
       }
   }
   ```

### éƒ¨ç½²é…ç½®

1. **JVMå‚æ•°ä¼˜åŒ–**
   ```bash
   # ç”Ÿäº§ç¯å¢ƒå¯åŠ¨å‚æ•°
   java -server \
        -Xmx8g \
        -Xms8g \
        -XX:+UseZGC \
        -XX:+UnlockExperimentalVMOptions \
        -XX:+EnableJVMCI \
        --enable-preview \
        -Dspring.profiles.active=prod \
        -jar quantcapital-engine.jar
   ```

2. **Dockeréƒ¨ç½²**
   ```dockerfile
   FROM openjdk:21-jdk-slim
   
   COPY target/quantcapital-engine.jar app.jar
   
   EXPOSE 8080
   
   ENV JAVA_OPTS="-Xmx8g -XX:+UseZGC"
   
   ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app.jar"]
   ```

## ğŸ¤– AIè¾…åŠ©å¼€å‘æŒ‡å—

### Cursor IDE é›†æˆ

1. **è‡ªåŠ¨ä»£ç ç”Ÿæˆ**
   - ä½¿ç”¨æ³¨é‡Šæè¿°éœ€æ±‚ï¼ŒAIè‡ªåŠ¨ç”Ÿæˆå®ç°ä»£ç 
   - å¿«æ·é”®ï¼š`Ctrl+K` ç”Ÿæˆä»£ç 
   
2. **ä»£ç é‡æ„**
   - é€‰ä¸­ä»£ç å—ï¼Œä½¿ç”¨`Ctrl+K`é‡æ„ä¼˜åŒ–
   - AIä¼šæä¾›æ€§èƒ½å’Œå¯è¯»æ€§æ”¹è¿›å»ºè®®

3. **æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ**
   - åœ¨æ–¹æ³•ä¸Šä½¿ç”¨`@GenerateTest`æ³¨è§£
   - AIè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„å•å…ƒæµ‹è¯•

### å¼€å‘æœ€ä½³å®è·µ

1. **æ¸è¿›å¼å¼€å‘**ï¼šä¼˜å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼Œé€æ­¥æ·»åŠ ç‰¹æ€§
2. **æµ‹è¯•é©±åŠ¨**ï¼šå…ˆå†™æµ‹è¯•ï¼Œå†å®ç°åŠŸèƒ½
3. **æ–‡æ¡£åŒæ­¥**ï¼šä»£ç å˜æ›´æ—¶åŒæ­¥æ›´æ–°æ–‡æ¡£
4. **æ€§èƒ½ä¼˜å…ˆ**ï¼šå…³é”®è·¯å¾„ä¼˜å…ˆè€ƒè™‘æ€§èƒ½
5. **å¯è§‚æµ‹æ€§**ï¼šæ·»åŠ å……åˆ†çš„æ—¥å¿—å’Œç›‘æ§

---

**æ³¨æ„**ï¼šæœ¬ç³»ç»Ÿç”¨äºå­¦ä¹ ç ”ç©¶ç›®çš„ï¼Œå®é™…ä½¿ç”¨è¯·å……åˆ†æµ‹è¯•å¹¶éµå®ˆç›¸å…³æ³•è§„ã€‚