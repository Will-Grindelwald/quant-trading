# QuantCapital Javaäº¤æ˜“å¼•æ“ - å¼€å‘è€…æŒ‡å—

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### æ··åˆæ¶æ„è®¾è®¡

æœ¬é¡¹ç›®é‡‡ç”¨Python+Javaæ··åˆæ¶æ„ï¼Œå……åˆ†å‘æŒ¥ä¸¤ç§è¯­è¨€çš„ä¼˜åŠ¿ï¼š

```mermaid
graph TB
    subgraph "Python æ•°æ®å±‚"
        A[AKShareæ•°æ®è·å–] --> B[æŠ€æœ¯æŒ‡æ ‡è®¡ç®—]
        B --> C[æ•°æ®æ¸…æ´—éªŒè¯]
        C --> D[å­˜å‚¨ç®¡ç†]
        D --> E[Parquetæ–‡ä»¶]
        D --> F[DuckDB]
        D --> G[SQLite]
    end
    
    subgraph "Java äº¤æ˜“å¼•æ“"
        H[äº‹ä»¶é©±åŠ¨å¼•æ“] --> I[ç­–ç•¥æ‰§è¡Œæ¡†æ¶]
        I --> J[ç»„åˆé£æ§ç³»ç»Ÿ]
        J --> K[äº¤æ˜“æ‰§è¡Œå¼•æ“]
        K --> L[å›æµ‹å¼•æ“]
    end
    
    E --> H
    F --> H
    G --> H
```

### æŠ€æœ¯æ ˆ

#### Javaç«¯æŠ€æœ¯æ ˆ
- **æ ¸å¿ƒ**: Spring Boot 3, JDK 21, Maven
- **æ•°æ®å¤„ç†**: Tablesaw, Apache Arrow, Apache Parquet
- **æ•°æ®åº“**: DuckDB JDBC, SQLite JDBC
- **å¹¶å‘**: è™šæ‹Ÿçº¿ç¨‹, BlockingQueue, ThreadPool
- **åºåˆ—åŒ–**: Jackson
- **å·¥å…·**: Lombok, Guava, Commons Lang
- **æµ‹è¯•**: JUnit 5, Mockito, AssertJ
- **ç›‘æ§**: Spring Actuator

#### æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
- **ZGCåƒåœ¾æ”¶é›†å™¨**: ä½å»¶è¿ŸGCï¼Œåœé¡¿æ—¶é—´<10ms
- **è™šæ‹Ÿçº¿ç¨‹**: Project Loomï¼Œè½»é‡çº§å¹¶å‘
- **Apache Arrow**: å†…å­˜åˆ—å¼å­˜å‚¨ï¼Œé«˜æ•ˆæ•°æ®äº¤æ¢
- **DuckDB**: å†…å­˜åˆ†ææ•°æ®åº“ï¼Œåˆ—å¼æŸ¥è¯¢ä¼˜åŒ–

## ğŸ“¦ æ¨¡å—ç»“æ„

```
src/main/java/com/quantcapital/
â”œâ”€â”€ entities/           # æ ¸å¿ƒå®ä½“ç±»
â”‚   â”œâ”€â”€ Event.java     # äº‹ä»¶åŸºç±»
â”‚   â”œâ”€â”€ Bar.java       # Kçº¿æ•°æ®
â”‚   â”œâ”€â”€ Signal.java    # äº¤æ˜“ä¿¡å·
â”‚   â”œâ”€â”€ Order.java     # è®¢å•
â”‚   â””â”€â”€ Fill.java      # æˆäº¤
â”œâ”€â”€ engine/            # äº‹ä»¶é©±åŠ¨å¼•æ“
â”‚   â”œâ”€â”€ EventEngine.java
â”‚   â””â”€â”€ EventHandler.java
â”œâ”€â”€ data/              # æ•°æ®è®¿é—®å±‚
â”‚   â””â”€â”€ DataHandler.java
â”œâ”€â”€ strategy/          # ç­–ç•¥æ¡†æ¶
â”‚   â””â”€â”€ BaseStrategy.java
â”œâ”€â”€ portfolio/         # ç»„åˆé£æ§
â”œâ”€â”€ execution/         # æ‰§è¡Œå¼•æ“
â”œâ”€â”€ backtest/          # å›æµ‹å¼•æ“
â””â”€â”€ config/            # é…ç½®ç®¡ç†
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. äº‹ä»¶é©±åŠ¨å¼•æ“

#### è®¾è®¡åŸç†
```java
/**
 * é«˜æ€§èƒ½äº‹ä»¶åˆ†å‘ç³»ç»Ÿç‰¹æ€§ï¼š
 * 1. ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼šé‡è¦äº‹ä»¶ä¼˜å…ˆå¤„ç†
 * 2. è™šæ‹Ÿçº¿ç¨‹ï¼šé«˜å¹¶å‘ä½å»¶è¿Ÿ
 * 3. å¼‚æ­¥å¤„ç†ï¼šé¿å…é˜»å¡
 * 4. æ•…éšœéš”ç¦»ï¼šå•å¤„ç†å™¨å¼‚å¸¸ä¸å½±å“æ•´ä½“
 * 5. èƒŒå‹å¤„ç†ï¼šé˜²æ­¢å†…å­˜æº¢å‡º
 */
@Component
public class EventEngine {
    // ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ŒæŒ‰äº‹ä»¶ä¼˜å…ˆçº§æ’åº
    private PriorityBlockingQueue<Event> eventQueue;
    
    // è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œå™¨
    private ExecutorService executorService = 
        Executors.newVirtualThreadPerTaskExecutor();
}
```

#### äº‹ä»¶å¤„ç†æµç¨‹
```java
// 1. äº‹ä»¶å‘å¸ƒ
boolean published = eventEngine.publishEvent(marketEvent);

// 2. ä¼˜å…ˆçº§åˆ†å‘
dispatchEvent(event) {
    List<EventHandler> handlers = getHandlers(event.getType());
    
    // 3. å¹¶è¡Œå¤„ç†ï¼ˆè™šæ‹Ÿçº¿ç¨‹ï¼‰
    for (EventHandler handler : handlers) {
        executorService.submit(() -> {
            handler.handleEvent(event);
        });
    }
}
```

### 2. æ•°æ®è®¿é—®å±‚

#### ç»Ÿä¸€æ•°æ®æ¥å£
```java
public interface DataHandler {
    // Kçº¿æ•°æ®è®¿é—® (OLAP)
    Table getBars(List<String> symbols, LocalDate start, LocalDate end, Frequency freq);
    Bar getLatestBar(String symbol, Frequency frequency);
    
    // ä¸šåŠ¡æ•°æ®è®¿é—® (OLTP)
    List<String> getUniverse(LocalDate date);
    boolean isTradingDay(LocalDate date);
    Map<String, Object> getStockInfo(String symbol);
}
```

#### æ•°æ®å­˜å‚¨å±‚çº§
```java
/**
 * åˆ†å±‚å­˜å‚¨æ¶æ„ï¼š
 * 
 * åº”ç”¨å±‚ â†â†’ DuckDB(å†…å­˜æŸ¥è¯¢) â†â†’ Parquet(é•¿æœŸå­˜æ¡£)
 *               â†“
 *           SQLite(ä¸šåŠ¡æ•°æ®)
 */
public class BacktestDataHandler implements DataHandler {
    
    private Connection duckdbConnection;  // å†…å­˜åˆ†ææ•°æ®åº“
    private Connection sqliteConnection;  // ä¸šåŠ¡æ•°æ®åº“
    
    @Override
    public Table getBars(List<String> symbols, LocalDate start, LocalDate end, Frequency freq) {
        // 1. ä»DuckDBæŸ¥è¯¢ï¼ˆä¼˜å…ˆï¼‰
        String sql = """
            SELECT * FROM read_parquet('data/kline/frequency=%s/*.parquet')
            WHERE symbol IN (%s) AND date BETWEEN ? AND ?
            ORDER BY symbol, datetime
            """.formatted(freq.getCode(), joinSymbols(symbols));
            
        return Table.read().db(duckdbConnection, sql, start, end);
    }
}
```

### 3. ç­–ç•¥æ¡†æ¶

#### ç­–ç•¥åˆ†ç±»ä¸èŒè´£
```java
public enum StrategyType {
    ENTRY,           // å¼€å•ç­–ç•¥ï¼šå¯»æ‰¾å¼€ä»“æœºä¼š
    EXIT,            // æ­¢ç›ˆæ­¢æŸç­–ç•¥ï¼šç®¡ç†å·²æœ‰æŒä»“  
    UNIVERSAL_STOP   // é€šç”¨å¼ºåˆ¶æ­¢æŸï¼šå…œåº•é£æ§
}

public interface BaseStrategy extends EventHandler {
    List<String> getWatchSymbols();  // åŠ¨æ€å…³æ³¨æ ‡çš„
    List<Signal> onMarketEvent(MarketEvent event);  // æ ¸å¿ƒç­–ç•¥é€»è¾‘
    void onFillEvent(FillEvent event);  // æŒä»“çŠ¶æ€æ›´æ–°
}
```

#### ç­–ç•¥è¿è¡Œæ¶æ„
```java
@Component
public class StrategyManager {
    
    public void initializeStrategies() {
        for (BaseStrategy strategy : strategies) {
            // æ ¹æ®ç­–ç•¥ç±»å‹æ³¨å†Œä¸åŒäº‹ä»¶
            if (strategy.getStrategyType() == StrategyType.ENTRY) {
                // å¼€å•ç­–ç•¥å…³æ³¨å…¨å¸‚åœº - å·²æŒæœ‰æ ‡çš„
                eventEngine.registerHandler("MARKET", strategy);
            } else if (strategy.getStrategyType() == StrategyType.EXIT) {
                // æ­¢ç›ˆæ­¢æŸç­–ç•¥ä»…å…³æ³¨æŒä»“æ ‡çš„
                eventEngine.registerHandler("MARKET", strategy);
                eventEngine.registerHandler("FILL", strategy);
            }
        }
    }
}
```

### 4. ç»„åˆé£æ§ç³»ç»Ÿ

#### ä¿¡å·å¤„ç†ä¸é£æ§
```java
@Component
public class PortfolioRiskManager implements EventHandler {
    
    @Override
    public void handleEvent(Event event) {
        if (event instanceof SignalEvent signalEvent) {
            processSignal(signalEvent.getSignal());
        } else if (event instanceof FillEvent fillEvent) {
            updatePositions(fillEvent.getFill());
        }
    }
    
    private void processSignal(Signal signal) {
        // 1. ä¿¡å·å»é‡å’Œå†²çªè§£å†³
        if (isDuplicateSignal(signal)) return;
        
        // 2. é£æ§æ£€æŸ¥
        if (!passRiskCheck(signal)) return;
        
        // 3. èµ„é‡‘åˆ†é…
        double positionSize = calculatePositionSize(signal);
        
        // 4. ç”Ÿæˆè®¢å•
        Order order = signalToOrder(signal, positionSize);
        
        // 5. å‘å¸ƒè®¢å•äº‹ä»¶
        OrderEvent orderEvent = new OrderEvent(LocalDateTime.now(), order, OrderAction.NEW);
        eventEngine.publishEvent(orderEvent);
    }
}
```

#### é£æ§æ£€æŸ¥è§„åˆ™
```java
private boolean passRiskCheck(Signal signal) {
    // 1. ä»“ä½é™åˆ¶æ£€æŸ¥
    if (getPositionPercent(signal.getSymbol()) + getNewPositionPercent(signal) 
        > maxPositionPercent) {
        log.warn("è¶…å‡ºå•æ ‡çš„ä»“ä½é™åˆ¶: {}", signal.getSymbol());
        return false;
    }
    
    // 2. æ€»ä»“ä½æ£€æŸ¥
    if (getTotalPositionPercent() + getNewPositionPercent(signal) 
        > maxTotalPositionPercent) {
        log.warn("è¶…å‡ºæ€»ä»“ä½é™åˆ¶");
        return false;
    }
    
    // 3. èµ„é‡‘å……è¶³æ€§æ£€æŸ¥
    if (getAvailableCash() < calculateOrderValue(signal)) {
        log.warn("å¯ç”¨èµ„é‡‘ä¸è¶³");
        return false;
    }
    
    // 4. åˆè§„æ€§æ£€æŸ¥
    if (isStockRestricted(signal.getSymbol())) {
        log.warn("æ ‡çš„å—é™: {}", signal.getSymbol());
        return false;
    }
    
    return true;
}
```

### 5. æ‰§è¡Œå¼•æ“

#### å›æµ‹æ‰§è¡Œå™¨
```java
@Component
public class SimulatedExecutionHandler implements ExecutionHandler {
    
    @Override
    public void executeOrder(Order order) {
        // 1. å»¶è¿Ÿæ¨¡æ‹Ÿ
        simulateDelay(executionConfig.getDelayMs());
        
        // 2. æ»‘ç‚¹è®¡ç®—
        double executionPrice = calculateExecutionPrice(order);
        
        // 3. ç”Ÿæˆæˆäº¤
        Fill fill = new Fill(
            order.getOrderId(),
            order.getSymbol(),
            order.getSide(),
            order.getQuantity(),
            executionPrice,
            LocalDateTime.now(),
            order.getStrategyId()
        );
        
        // 4. æ‰‹ç»­è´¹è®¡ç®—
        fill.calculateFeesWithCustomRates(
            executionConfig.getCommissionRate(),
            0.001,  // å°èŠ±ç¨
            0.00002, // è¿‡æˆ·è´¹
            5.0     // æœ€ä½æ‰‹ç»­è´¹
        );
        
        // 5. å‘å¸ƒæˆäº¤äº‹ä»¶
        FillEvent fillEvent = new FillEvent(LocalDateTime.now(), fill);
        eventEngine.publishEvent(fillEvent);
    }
}
```

## ğŸ§ª æµ‹è¯•æ¡†æ¶

### å•å…ƒæµ‹è¯•è§„èŒƒ

#### 1. æµ‹è¯•å‘½åè§„èŒƒ
```java
@Test
void should_PublishAndHandleEvent_When_EventEngineIsRunning() {
    // Given - ç»™å®šæ¡ä»¶
    // When - æ‰§è¡Œæ“ä½œ  
    // Then - éªŒè¯ç»“æœ
}
```

#### 2. äº‹ä»¶å¼•æ“æµ‹è¯•
```java
@SpringBootTest
class EventEngineTest {
    
    @Test
    void testEventPriority() throws InterruptedException {
        // æµ‹è¯•ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯å¦æŒ‰ä¼˜å…ˆçº§å¤„ç†äº‹ä»¶
        CountDownLatch latch = new CountDownLatch(3);
        AtomicInteger processOrder = new AtomicInteger(0);
        
        // åˆ›å»ºä¸åŒä¼˜å…ˆçº§äº‹ä»¶
        TimerEvent highPriorityEvent = new TimerEvent(now(), MARKET_DATA_UPDATE, 1000);
        TimerEvent lowPriorityEvent = new TimerEvent(now(), CLEANUP, 1000);
        
        // éªŒè¯é«˜ä¼˜å…ˆçº§äº‹ä»¶å…ˆè¢«å¤„ç†
        // ...
    }
}
```

#### 3. ç­–ç•¥æµ‹è¯•æ¨¡æ¿
```java
@ExtendWith(MockitoExtension.class)
class StrategyTest {
    
    @Mock
    private EventEngine eventEngine;
    
    @Mock
    private DataHandler dataHandler;
    
    @InjectMocks
    private MACrossStrategy strategy;
    
    @Test
    void should_GenerateBuySignal_When_GoldenCross() {
        // æ„é€ æµ‹è¯•æ•°æ®
        Bar bar = createTestBar("000001.SZ", 10.0, 10.5, 9.5, 10.2);
        bar.setMa5(10.3);  // MA5 > MA20
        bar.setMa20(10.1);
        
        MarketEvent event = new MarketEvent(LocalDateTime.now(), bar, Frequency.DAILY);
        
        // æ‰§è¡Œç­–ç•¥
        List<Signal> signals = strategy.onMarketEvent(event);
        
        // éªŒè¯ç»“æœ
        assertThat(signals).hasSize(1);
        assertThat(signals.get(0).getDirection()).isEqualTo(SignalDirection.BUY);
    }
}
```

### é›†æˆæµ‹è¯•

#### ç«¯åˆ°ç«¯å›æµ‹æµ‹è¯•
```java
@SpringBootTest
@TestPropertySource(properties = {
    "quantcapital.mode=backtest",
    "quantcapital.data.root-path=src/test/resources/test-data"
})
class BacktestIntegrationTest {
    
    @Test
    void should_CompleteBacktest_When_ValidConfiguration() {
        // é…ç½®å›æµ‹å‚æ•°
        BacktestConfig config = BacktestConfig.builder()
            .startDate("2023-01-01")
            .endDate("2023-01-31") 
            .universe(List.of("000001.SZ"))
            .initialCapital(100000.0)
            .build();
        
        // æ‰§è¡Œå›æµ‹
        BacktestEngine engine = new BacktestEngine(config);
        BacktestResult result = engine.run();
        
        // éªŒè¯ç»“æœ
        assertThat(result.getFinalCapital()).isGreaterThan(0);
        assertThat(result.getTotalTrades()).isGreaterThan(0);
        assertThat(result.getMaxDrawdown()).isLessThan(0.5); // æœ€å¤§å›æ’¤<50%
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### JVMè°ƒä¼˜

#### å¯åŠ¨å‚æ•°
```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
java -XX:+UseZGC \                          # ä½¿ç”¨ZGCä½å»¶è¿ŸGC
     -XX:+UnlockExperimentalVMOptions \     # è§£é”å®éªŒæ€§åŠŸèƒ½
     -Xmx8g \                               # æœ€å¤§å †å†…å­˜
     -XX:+FlightRecorder \                  # å¯ç”¨JFRæ€§èƒ½åˆ†æ
     -XX:+UseTransparentHugePages \         # å¯ç”¨å¤§é¡µå†…å­˜
     --enable-preview \                     # å¯ç”¨é¢„è§ˆåŠŸèƒ½ï¼ˆè™šæ‹Ÿçº¿ç¨‹ï¼‰
     -jar quant-trading-java.jar
```

#### å†…å­˜é…ç½®
```yaml
# application-prod.yml
quantcapital:
  engine:
    queue-capacity: 50000      # å¢å¤§é˜Ÿåˆ—å®¹é‡
    worker-threads: 8          # æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
    batch-size: 500           # å¢å¤§æ‰¹å¤„ç†å¤§å°
  
  data:
    preload-days: 200         # é¢„åŠ è½½æ›´å¤šå†å²æ•°æ®
```

### å¹¶å‘ä¼˜åŒ–

#### è™šæ‹Ÿçº¿ç¨‹ä½¿ç”¨
```java
// ä¼ ç»Ÿçº¿ç¨‹æ±  vs è™šæ‹Ÿçº¿ç¨‹
// ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸æ¨èï¼‰
ExecutorService oldExecutor = Executors.newFixedThreadPool(100);

// è™šæ‹Ÿçº¿ç¨‹æ–¹å¼ï¼ˆæ¨èï¼‰
ExecutorService virtualExecutor = Executors.newVirtualThreadPerTaskExecutor();

// å¤„ç†å¤§é‡å¹¶å‘ä»»åŠ¡
for (int i = 0; i < 10000; i++) {
    virtualExecutor.submit(() -> {
        // å¤„ç†ä»»åŠ¡ï¼ˆå¯ä»¥æ˜¯IOå¯†é›†å‹ï¼‰
        processMarketData();
    });
}
```

#### äº‹ä»¶å¤„ç†ä¼˜åŒ–
```java
@Component
public class OptimizedEventEngine {
    
    // ä½¿ç”¨å¤šä¸ªé˜Ÿåˆ—å‡å°‘ç«äº‰
    private final List<PriorityBlockingQueue<Event>> eventQueues;
    
    public void publishEvent(Event event) {
        // æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘åˆ°ä¸åŒé˜Ÿåˆ—
        int queueIndex = getQueueIndex(event);
        eventQueues.get(queueIndex).offer(event);
    }
    
    private int getQueueIndex(Event event) {
        // ä½¿ç”¨å“ˆå¸Œåˆ†åŒºå‡å°‘ç«äº‰
        return Math.abs(event.getSymbol().hashCode()) % eventQueues.size();
    }
}
```

### æ•°æ®è®¿é—®ä¼˜åŒ–

#### ç¼“å­˜ç­–ç•¥
```java
@Component
public class CachedDataHandler implements DataHandler {
    
    // ä½¿ç”¨Caffeineç¼“å­˜çƒ­ç‚¹æ•°æ®
    private final Cache<String, Bar> latestBarCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    @Override
    public Bar getLatestBar(String symbol, Frequency frequency) {
        String cacheKey = symbol + ":" + frequency;
        return latestBarCache.get(cacheKey, key -> loadFromDatabase(symbol, frequency));
    }
}
```

## ğŸ“Š ç›‘æ§å’ŒæŒ‡æ ‡

### å…³é”®æ€§èƒ½æŒ‡æ ‡

```java
@Component
public class MetricsCollector {
    
    private final MeterRegistry meterRegistry;
    
    // äº‹ä»¶å¤„ç†å»¶è¿Ÿ
    private final Timer eventProcessingTimer;
    
    // ç­–ç•¥æ‰§è¡Œè®¡æ•°
    private final Counter strategyExecutionCounter;
    
    // è®¢å•å¤„ç†é€Ÿç‡
    private final Gauge orderProcessingRate;
    
    public void recordEventProcessing(String eventType, Duration duration) {
        eventProcessingTimer.record(duration);
    }
}
```

### ç›‘æ§ç«¯ç‚¹
```java
@RestController
@RequestMapping("/api/monitoring")
public class MonitoringController {
    
    @GetMapping("/engine/stats")
    public Map<String, Object> getEngineStatistics() {
        return Map.of(
            "queueSize", eventEngine.getQueueSize(),
            "processedEvents", eventEngine.getProcessedCount(),
            "eventsPerSecond", eventEngine.getEventsPerSecond(),
            "avgProcessingTime", eventEngine.getAvgProcessingTime()
        );
    }
    
    @GetMapping("/strategies/performance")
    public List<StrategyPerformance> getStrategyPerformance() {
        return strategyManager.getAllStrategies().stream()
            .map(this::buildPerformanceMetrics)
            .collect(Collectors.toList());
    }
}
```

## ğŸ”§ å¼€å‘è§„èŒƒ

### ä»£ç é£æ ¼

#### 1. å‘½åè§„èŒƒ
```java
// ç±»åï¼šå¤§é©¼å³°ï¼Œå«ä¹‰æ˜ç¡®
public class MarketDataProcessor

// æ–¹æ³•åï¼šå°é©¼å³°ï¼ŒåŠ¨è¯å¼€å¤´
public void processMarketEvent()
public boolean isValidSignal()
public List<Order> generateOrders()

// å¸¸é‡ï¼šå…¨å¤§å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”
public static final int MAX_POSITION_SIZE = 10000;
public static final String DEFAULT_STRATEGY_ID = "default_strategy";

// æšä¸¾ï¼šå¤§é©¼å³°
public enum OrderStatus { PENDING, FILLED, CANCELLED }
```

#### 2. æ³¨é‡Šè§„èŒƒ
```java
/**
 * å¤„ç†å¸‚åœºæ•°æ®äº‹ä»¶ï¼Œç”Ÿæˆäº¤æ˜“ä¿¡å·
 * 
 * @param marketEvent å¸‚åœºæ•°æ®äº‹ä»¶ï¼ŒåŒ…å«æœ€æ–°çš„Kçº¿æ•°æ®
 * @return ç”Ÿæˆçš„ä¿¡å·åˆ—è¡¨ï¼Œå¯èƒ½ä¸ºç©º
 * @throws StrategyException å½“ç­–ç•¥æ‰§è¡Œå‡ºç°å¼‚å¸¸æ—¶
 */
public List<Signal> processMarketEvent(MarketEvent marketEvent) throws StrategyException {
    // 1. éªŒè¯è¾“å…¥å‚æ•°
    if (marketEvent == null || marketEvent.getBar() == null) {
        log.warn("æ¥æ”¶åˆ°æ— æ•ˆçš„å¸‚åœºäº‹ä»¶");
        return Collections.emptyList();
    }
    
    // 2. æ‰§è¡Œç­–ç•¥é€»è¾‘
    Bar currentBar = marketEvent.getBar();
    List<Signal> signals = new ArrayList<>();
    
    // TODO: å®ç°å…·ä½“çš„ç­–ç•¥é€»è¾‘
    
    return signals;
}
```

#### 3. å¼‚å¸¸å¤„ç†
```java
public class StrategyException extends Exception {
    public StrategyException(String message, Throwable cause) {
        super(message, cause);
    }
}

// å¼‚å¸¸å¤„ç†ç¤ºä¾‹
try {
    List<Signal> signals = strategy.processMarketEvent(event);
    signalProcessor.processSignals(signals);
} catch (StrategyException e) {
    log.error("ç­–ç•¥æ‰§è¡Œå¤±è´¥: ç­–ç•¥ID={}, é”™è¯¯={}", strategy.getStrategyId(), e.getMessage(), e);
    metricsCollector.recordStrategyError(strategy.getStrategyId());
} catch (Exception e) {
    log.error("æœªé¢„æœŸçš„ç­–ç•¥å¼‚å¸¸: ç­–ç•¥ID={}", strategy.getStrategyId(), e);
    // å‘é€å‘Šè­¦
    alertService.sendAlert("ç­–ç•¥æ‰§è¡Œå¼‚å¸¸", e);
}
```

### Gitæäº¤è§„èŒƒ

```bash
# æäº¤æ ¼å¼
<type>(<scope>): <subject>

# ç±»å‹è¯´æ˜
feat:     æ–°åŠŸèƒ½
fix:      ä¿®å¤Bug
docs:     æ–‡æ¡£æ›´æ–°
style:    ä»£ç æ ¼å¼è°ƒæ•´
refactor: é‡æ„
test:     æµ‹è¯•ç›¸å…³
chore:    æ„å»º/å·¥å…·é“¾

# ç¤ºä¾‹
feat(engine): æ·»åŠ äº‹ä»¶ä¼˜å…ˆçº§é˜Ÿåˆ—æ”¯æŒ
fix(strategy): ä¿®å¤å‡çº¿äº¤å‰ç­–ç•¥çš„é‡‘å‰æ£€æµ‹é€»è¾‘
docs(api): æ›´æ–°ç­–ç•¥å¼€å‘APIæ–‡æ¡£
test(portfolio): æ·»åŠ é£æ§æ¨¡å—å•å…ƒæµ‹è¯•
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜æ’æŸ¥

#### 1. äº‹ä»¶å¤„ç†å»¶è¿Ÿ
```java
// æ£€æŸ¥ç‚¹1ï¼šäº‹ä»¶é˜Ÿåˆ—å¤§å°
int queueSize = eventEngine.getQueueSize();
if (queueSize > 1000) {
    log.warn("äº‹ä»¶é˜Ÿåˆ—å †ç§¯ï¼Œå½“å‰å¤§å°: {}", queueSize);
    // å¯èƒ½åŸå› ï¼šå¤„ç†å™¨æ€§èƒ½ç“¶é¢ˆã€èµ„æºä¸è¶³
}

// æ£€æŸ¥ç‚¹2ï¼šå¤„ç†å™¨æ€§èƒ½
Map<String, Double> processingTimes = eventEngine.getHandlerProcessingTimes();
processingTimes.forEach((handler, avgTime) -> {
    if (avgTime > 100) { // è¶…è¿‡100ms
        log.warn("å¤„ç†å™¨æ€§èƒ½å¼‚å¸¸: handler={}, avgTime={}ms", handler, avgTime);
    }
});
```

#### 2. å†…å­˜æ³„æ¼æ’æŸ¥
```bash
# ä½¿ç”¨JFRåˆ†æå†…å­˜ä½¿ç”¨
java -XX:+FlightRecorder \
     -XX:StartFlightRecording=duration=60s,filename=memory-analysis.jfr \
     -jar trading-engine.jar

# åˆ†æGCæ—¥å¿—
-XX:+UseZGC -XX:+PrintGC -XX:+PrintGCDetails
```

#### 3. æ•°æ®è®¿é—®é—®é¢˜
```java
// æ•°æ®è¿æ¥æ£€æŸ¥
@Component
public class DataHealthChecker {
    
    @EventListener
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkDataConnections() {
        try {
            // æ£€æŸ¥DuckDBè¿æ¥
            duckdbConnection.createStatement()
                .executeQuery("SELECT 1").close();
            
            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            LocalDate today = LocalDate.now();
            List<String> symbols = dataHandler.getUniverse(today);
            if (symbols.isEmpty()) {
                alertService.sendAlert("è‚¡ç¥¨æ± æ•°æ®ä¸ºç©º", today.toString());
            }
            
        } catch (SQLException e) {
            log.error("æ•°æ®è¿æ¥æ£€æŸ¥å¤±è´¥", e);
            alertService.sendAlert("æ•°æ®è¿æ¥å¼‚å¸¸", e.getMessage());
        }
    }
}
```

## ğŸ“ AI Coder (Cursor) å¼€å‘æç¤º

### é¡¹ç›®ä¸Šä¸‹æ–‡
å½“æ‚¨ä½¿ç”¨Cursorå¼€å‘æ­¤é¡¹ç›®æ—¶ï¼Œè¯·äº†è§£ä»¥ä¸‹ä¸Šä¸‹æ–‡ï¼š

1. **æ¶æ„ç†å¿µ**: è¿™æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„æ··åˆæ¶æ„ç³»ç»Ÿï¼ŒJavaè´Ÿè´£é«˜æ€§èƒ½äº¤æ˜“é€»è¾‘ï¼ŒPythonè´Ÿè´£æ•°æ®è·å–
2. **æ€§èƒ½å¯¼å‘**: æ‰€æœ‰è®¾è®¡éƒ½ä»¥ä½å»¶è¿Ÿã€é«˜ååä¸ºç›®æ ‡ï¼Œä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹å’ŒZGC
3. **æ•°æ®ä¸€è‡´æ€§**: Javaç«¯åªè¯»å–Pythonç”Ÿæˆçš„æ•°æ®ï¼Œä¸ä¿®æ”¹æ•°æ®æº
4. **æ¨¡å—åŒ–**: æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œé€šè¿‡äº‹ä»¶è¿›è¡Œé€šä¿¡

### å¼€å‘æŒ‡å¯¼åŸåˆ™

1. **ä¼˜å…ˆä½¿ç”¨ç°æœ‰ç»„ä»¶**: å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ç°æˆçš„æ¥å£æˆ–åŸºç±»å¯ä»¥ç»§æ‰¿
2. **ä¿æŒäº‹ä»¶é©±åŠ¨**: æ¨¡å—é—´é€šä¿¡å¿…é¡»é€šè¿‡äº‹ä»¶ï¼Œé¿å…ç›´æ¥è°ƒç”¨
3. **å¼‚å¸¸å®‰å…¨**: æ‰€æœ‰å¼‚å¸¸éƒ½è¦å¦¥å–„å¤„ç†ï¼Œä¸èƒ½å½±å“äº‹ä»¶å¼•æ“è¿è¡Œ
4. **æ€§èƒ½æ„è¯†**: é¿å…é˜»å¡æ“ä½œï¼Œä¼˜å…ˆä½¿ç”¨å¼‚æ­¥å¤„ç†
5. **æµ‹è¯•é©±åŠ¨**: æ–°åŠŸèƒ½å¿…é¡»æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•

### å¸¸ç”¨ä»£ç æ¨¡æ¿

#### æ–°å»ºç­–ç•¥æ¨¡æ¿
```java
@Component
public class NewStrategy implements BaseStrategy {
    
    private static final String STRATEGY_ID = "new_strategy";
    private final EventEngine eventEngine;
    private StrategyStatus status = StrategyStatus.NOT_INITIALIZED;
    
    @Override
    public List<Signal> onMarketEvent(MarketEvent event) {
        // å®ç°ç­–ç•¥é€»è¾‘
        return List.of();
    }
    
    // å®ç°å…¶ä»–å¿…é¡»çš„æ–¹æ³•...
}
```

#### æ–°å»ºäº‹ä»¶å¤„ç†å™¨æ¨¡æ¿
```java
@Component
public class NewEventHandler implements EventHandler {
    
    @Override
    public String getName() {
        return "NewEventHandler";
    }
    
    @Override
    public void handleEvent(Event event) {
        try {
            // å¤„ç†é€»è¾‘
        } catch (Exception e) {
            log.error("äº‹ä»¶å¤„ç†å¤±è´¥: {}", event, e);
        }
    }
}
```

---

> **å¼€å‘å›¢é˜Ÿ**: ä¿æŒä»£ç ç®€æ´ã€æ€§èƒ½ä¼˜å…ˆã€æ–‡æ¡£å®Œå–„çš„åŸåˆ™ï¼Œæ„å»ºé«˜è´¨é‡çš„é‡åŒ–äº¤æ˜“ç³»ç»Ÿã€‚